name: Cancel Action Required Workflows

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to cancel action_required workflows for (leave empty for all)'
        required: false
        type: string
      dry_run:
        description: 'Dry run mode - just list workflows without canceling'
        required: false
        type: boolean
        default: true

permissions:
  actions: write
  contents: read

jobs:
  cancel-action-required-workflows:
    runs-on: ubuntu-latest
    steps:
      - name: Cancel workflows with action_required status
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ inputs.pr_number }}';
            const dryRun = ${{ inputs.dry_run }};

            console.log(`Dry run mode: ${dryRun}`);
            console.log(`PR number filter: ${prNumber || 'all'}`);

            // Get all workflow runs for the Tests workflow
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            const testsWorkflow = workflows.data.workflows.find(w => w.name === 'Tests');
            if (!testsWorkflow) {
              console.log('Tests workflow not found');
              return;
            }

            console.log(`Found Tests workflow: ${testsWorkflow.id}`);

            // Get workflow runs with action_required status
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: testsWorkflow.id,
              per_page: 100
            });

            let actionRequiredRuns = runs.data.workflow_runs.filter(run =>
              run.conclusion === 'action_required' && run.status === 'completed'
            );

            // Filter by PR number if specified
            if (prNumber) {
              actionRequiredRuns = actionRequiredRuns.filter(run => {
                const pr = run.pull_requests && run.pull_requests.find(pr => pr.number === parseInt(prNumber));
                return pr !== undefined;
              });
            }

            console.log(`Found ${actionRequiredRuns.length} workflow runs with action_required status`);

            for (const run of actionRequiredRuns) {
              console.log(`\nRun #${run.run_number} (ID: ${run.id})`);
              console.log(`  Status: ${run.status}, Conclusion: ${run.conclusion}`);
              console.log(`  Branch: ${run.head_branch}`);
              console.log(`  Created: ${run.created_at}`);
              console.log(`  URL: ${run.html_url}`);

              if (!dryRun) {
                try {
                  await github.rest.actions.cancelWorkflowRun({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: run.id
                  });
                  console.log(`  ✓ Canceled`);
                } catch (error) {
                  console.log(`  ✗ Failed to cancel: ${error.message}`);
                }
              } else {
                console.log(`  [DRY RUN] Would cancel this run`);
              }
            }

            console.log(`\n=== Summary ===`);
            console.log(`Total action_required runs found: ${actionRequiredRuns.length}`);
            if (dryRun) {
              console.log(`Dry run mode - no runs were actually canceled`);
              console.log(`Set dry_run to false to actually cancel these runs`);
            } else {
              console.log(`Cancellation complete`);
            }
