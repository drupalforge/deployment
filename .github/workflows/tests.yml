name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review]

# Cancel in-progress runs when a new run is triggered
# This automatically cancels superseded workflow runs
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write  # Required to cancel workflow runs

jobs:
  cancel-previous-runs:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Cancel previous runs for this PR
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          CURRENT_RUN_ID: ${{ github.run_id }}
          WORKFLOW_ID: ${{ github.workflow_id }}
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER);
            const currentRunId = parseInt(process.env.CURRENT_RUN_ID);
            const workflowId = parseInt(process.env.WORKFLOW_ID);

            console.log(`Current run ID: ${currentRunId}`);
            console.log(`PR number: ${prNumber}`);
            console.log(`Workflow ID: ${workflowId}`);

            // Get all runs for this workflow
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflowId,
              per_page: 100
            });

            // Filter to runs for this PR that are not the current run
            const runsToCancel = runs.data.workflow_runs.filter(run => {
              // Skip the current run
              if (run.id === currentRunId) {
                return false;
              }

              // Check if this run is for the same PR
              const runPR = run.pull_requests.find(pr => pr.number === prNumber);
              if (!runPR) {
                return false;
              }

              // Cancel all matching runs regardless of status
              // Skip runs that are already in a terminal state
              if (run.status === 'completed') {
                // Only cancel completed runs with 'action_required' conclusion
                return run.conclusion === 'action_required';
              }
              // Cancel runs that are queued, in_progress, or waiting
              return true;
            });

            console.log(`Found ${runsToCancel.length} runs to cancel`);

            for (const run of runsToCancel) {
              console.log(`Cancelling run #${run.run_number} (ID: ${run.id}, status: ${run.status})`);
              try {
                await github.rest.actions.cancelWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id
                });
                console.log(`  ✓ Cancelled successfully`);
              } catch (error) {
                console.log(`  ✗ Failed to cancel: ${error.message}`);
              }
            }

  unit-tests:
    runs-on: ubuntu-latest
    needs: [cancel-previous-runs]
    if: always()

    steps:
      - uses: actions/checkout@v3

      - name: Set up shell test environment
        run: |
          # Install PHP for syntax checking
          sudo apt-get update
          sudo apt-get install -y php-cli php-curl

      - name: Run unit tests
        run: |
          bash tests/unit-test.sh

  docker-build:
    runs-on: ubuntu-latest
    needs: [cancel-previous-runs]
    if: always()

    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build PHP 8.2 image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          build-args: |
            PHP_VERSION=8.2
          push: false
          tags: ${{ github.repository }}:8.2-test

      - name: Build PHP 8.3 image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          build-args: |
            PHP_VERSION=8.3
          push: false
          tags: ${{ github.repository }}:8.3-test
