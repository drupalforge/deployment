# Drupal Forge Apache Proxy Configuration
# Conditional file serving with on-demand download:
# 1. Serves local files if they exist at the requested path
# 2. Routes missing files to PHP handler for download from origin
# 3. Downloaded files are saved to their expected path for future access
# This allows users to save files locally, while origin files are downloaded on first access

# Enable required modules for this configuration
# - mod_rewrite: for conditional logic (check if file exists, route to handler)
# - mod_proxy: for proxying responses within the handler

# Use file-based mutexes for portability in containerized/QEMU environments
# where default semaphore-backed mutexes may be unavailable.
Mutex file:/var/lock/apache2 default

# Expose proxy handler without writing into the web root.
# setup-proxy.sh targets this URL in rewrite rules.
Alias /drupalforge-proxy-handler.php /var/www/drupalforge-proxy-handler.php
<Location /drupalforge-proxy-handler.php>
  Require all granted
</Location>

# Rewrite rules: serve local file if it exists, otherwise call proxy handler.
# Scoped to web root directory so rewrites apply to requests handled by the site vhost.
# setup-proxy.sh replaces __WEB_ROOT__ at runtime.
<Directory "__WEB_ROOT__">
  <IfModule mod_rewrite.c>
    RewriteEngine On
    
    # For each proxied path (configured by setup-proxy.sh):
    # 1. Check if the requested file/directory exists locally
    # 2. If yes: stop rewriting and serve from disk
    # 3. If no: rewrite to proxy handler PHP script
    
    # Example for /sites/default/files:
    # RewriteCond %{REQUEST_URI} ^/sites/default/files
    # RewriteCond %{REQUEST_FILENAME} !-f
    # RewriteCond %{REQUEST_FILENAME} !-d
    # RewriteRule ^sites/default/files(/.*)?$ /drupalforge-proxy-handler.php [QSA,L]
  </IfModule>
</Directory>

# Proxy module configuration (for handler's curl requests)
<IfModule mod_proxy.c>
  <IfModule mod_proxy_http.c>
    # Handler script uses curl to download files, so proxy config is minimal
    
    # Preserve the original Host header
    ProxyPreserveHost On
    
    # Connection timeout
    ProxyTimeout 300
  </IfModule>
</IfModule>
